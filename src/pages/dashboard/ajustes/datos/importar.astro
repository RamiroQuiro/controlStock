---
import { eq } from 'drizzle-orm';
import db from '../../../../db';
import { categorias } from '../../../../db/schema';
import LayoutDash from '../../../../components/layouts/LayoutDash.astro';
import MainDashboard from '../../../../components/atomos/MainDashboard.astro';
import DivBox1 from '../../../../components/atomos/DivBox1.astro';
import { BoxIcon, Truck, UserSquare } from 'lucide-react';
import ImportadorGenerico from '../../../../components/organismos/ImportadorGenerico';
import { columnasResultados, columnasResultadosClientes, columnasResultadosProveedores } from '../../../../utils/columnasTables';
import Button4 from '../../../../components/atomos/Button4.astro';

const { user } = Astro.locals;
const empresaId = user?.empresaId;
const userId = user?.id;

// Obtenemos las categorías de la base de datos para la empresa actual
const categoriasExistentes = await db
  .select()
  .from(categorias)
  .where(eq(categorias.empresaId, empresaId));
---

<LayoutDash title="Importar Datos">
  <MainDashboard
    h1="Importar Datos"
    subtitle=" Sigue los pasos para realizar una carga masiva de productos a tu inventario."
  >
    <DivBox1 styleDiv="w-full p-6 items-center justify-center flex flex- bg-red-500">
      <div
        class="bg-white/5 border items-center justify-center w-11/12 mx-auto border-white/10 rounded-lg p- text-primary-texto"
      >
        <h2 class="text-xl font-semibold text-primary-textoTitle mb-2">Paso 1: Prepara tu archivo</h2>
        <p class="mb-4 text-sm">
          Descarga nuestra plantilla CSV. Es importante que uses los nombres de
          las categorías exactamente como aparecen en la siguiente lista para
          asegurar una correcta importación.
        </p>

        <div class="flex flex-col items-center justify-between md:flex-row gap-8">
          <!-- Columna de descarga -->
          <div class="flex flex-col gap-2 w-/3">
            <Button4>
              <a
                class="w-fit flex items-center justify-center text-primary-100 font-semibold"
                href="/plantillas/productos.csv"
                download
              >
                <BoxIcon className="mr-2" /> Descargar Plantilla de Productos
              </a>
            </Button4>
            <!-- planilla de clientes -->
            <Button4>
              <a
                href="/plantillas/clientes.csv"
                download
                class="w-fit flex items-center justify-center text-primary-100 font-semibold"
              >
                <UserSquare className="mr-2"/> Descargar Plantilla de Clientes
              </a>
            </Button4>
            <!-- planilla de proveedores -->
            <Button4>
              <a
                href="/plantillas/proveedores.csv"
                download
                class="w-fit flex items-center justify-center text-primary-100 font-semibold"
              >
                <Truck className="mr-2" /> Descargar Plantilla de Proveedores
              </a>
            </Button4>
          </div>
          <!-- Columna de categorías -->
          <div
            class="flex- w-2/3 border border-gray-700 rounded-lg p-4 bg-primary-bg-componentes"
          >
            <h3 class="font-semibold mb-2 text-primary-textoTitle">
              Categorías Disponibles:
            </h3>
            {
              categoriasExistentes.length > 0 ? (
                <ul class="list-disc list-inside text-sm  grid grid-cols-2 gap-1">
                  {categoriasExistentes.map((cat) => (
                    <li>{cat.nombre}</li>
                  ))}
                </ul>
              ) : (
                <p class="text-sm text-primary-400">
                  No has creado ninguna categoría todavía. Ve a la sección de
                  Stock para añadirlas.
                </p>
              )
            }
          </div>
        </div>

        <hr class="my-8 border-gray-700" />

        <h2 class="text-xl font-semibold mb-4 text-primary-textoTitle">Paso 2: Sube tu archivo</h2>
        <p class="mb-4">
          Una vez que hayas llenado la plantilla con tus productos, guárdala en
          formato CSV y súbela aquí.
        </p>

        <div id="upload-form-container">
          <ImportadorGenerico 
            client:load
            titulo="Importar Productos"
            endpoint="/api/ajustes/importarProductos"
            inputName="file-productos"
            columnasResultado={columnasResultados}
          />

          <ImportadorGenerico 
            client:load
            titulo="Importar Clientes"
            endpoint="/api/ajustes/importarClientes"
            inputName="file-clientes"
            columnasResultado={columnasResultadosClientes}
          />

          <ImportadorGenerico 
            client:load
            titulo="Importar Proveedores"
            endpoint="/api/ajustes/importarProveedores"
            inputName="file-proveedores"
            columnasResultado={columnasResultadosProveedores}
          />
        </div>
      </div>
    </DivBox1>
  </MainDashboard>
</LayoutDash>
