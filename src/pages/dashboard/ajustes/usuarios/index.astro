---
import MainDashboard from "../../../../components/atomos/MainDashboard.astro";
import LayoutDash from "../../../../components/layouts/LayoutDash.astro";
import SeccionUsuarios from "./SeccionUsuarios.astro";
import Modal from "../../../../components/moleculas/Modal.astro";
import FormularioNuevoUser from "../components/FormularioNuevoUser";
import FormularioNuevoUserEdit from "../components/FormularioNuevoUserEdit";
import FormularioNuevoRol from "../components/FormularioNuevoRol";
import SeccionRoles from "./SeccionRoles.astro";

import {
  depositos as depositosTable,
  roles as rolesTable,
} from "../../../../db/schema";
import db from "../../../../db";
import { eq } from "drizzle-orm";
import { ROLES_INICIALES } from "../../../../services/roles.sevice";

const { user } = Astro.locals;

let depositos: any[] = [];
try {
  depositos = await db
    .select({ id: depositosTable.id, nombre: depositosTable.nombre })
    .from(depositosTable)
    .where(eq(depositosTable.empresaId, user?.empresaId!));
} catch (error) {
  console.error("Error fetching depositos:", error);
}

// Roles base del sistema (hardcodeados)
const rolesBase = ROLES_INICIALES;

// Roles personalizados de la DB (ya vienen con prefijo rolCustom-)
let rolesPersonalizados: any[] = [];
try {
  rolesPersonalizados = await db
    .select({
      id: rolesTable.id,
      nombre: rolesTable.nombre,
      descripcion: rolesTable.descripcion,
      permisos: rolesTable.permisos,
    })
    .from(rolesTable)
    .where(eq(rolesTable.empresaId, user?.empresaId!));
} catch (error) {
  console.error("Error fetching roles:", error);
}
console.log("roles personalizados", rolesPersonalizados);
// Combinar ambos tipos de roles
const roles = [...rolesBase, ...rolesPersonalizados];

console.log("roles", roles);
interface NuevoUsuario {
  dni: number;
  id: string;
  isEdit: boolean;
  nombre: string;
  apellido: string;
  email: string;
  password: string;
  rol: string;
  tipoUsuario: "empleado" | "cliente" | "proveedor";
}
---

<LayoutDash title="Gesti贸n de Usuarios y Roles">
  <MainDashboard
    h1="Gesti贸n de Usuarios y Roles"
    subtitle="Creacion y gestion de usuarios y roles"
  >
    <div
      slot={"menu"}
      class="flex items-center w-fit justify-end pb-2 gap-2 pr-6 w-"
    >
      <div class="flex gap-3">
        <Modal id="modificarUser">
          <FormularioNuevoUserEdit
            depositos={depositos}
            roles={roles}
            client:visible
          />
        </Modal>
        <Modal label="+ Nuevo Usuario" id="crearUser" title="Nuevo Usuario">
          <FormularioNuevoUser
            userId={user?.id!}
            depositos={depositos}
            roles={roles}
            client:visible
          />
        </Modal>

        <Modal label="+ Nuevo Rol" id="crearRole" title="Nuevo Rol">
          <FormularioNuevoRol client:visible />
        </Modal>
      </div>
    </div>
    <div
      class="flex md:flex-row flex-col w-full items-stretch justify-between gap-2"
    >
      {/* Secci贸n de Usuarios */}
      <SeccionUsuarios />
      {/* Secci贸n de Roles y Permisos */}
      <SeccionRoles roles={roles} />
    </div>
  </MainDashboard>
</LayoutDash>

<style>
  table {
    border-collapse: separate;
    border-spacing: 0;
  }
</style>
