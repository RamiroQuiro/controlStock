---
import { 
  productos as productosSchema, 
  depositos as depositosSchema, 
  ubicaciones as ubicacionesSchema 
} from '../../../db/schema';
import { eq, and } from 'drizzle-orm';
import db from '../../../db';
import LayoutDash from '../../../components/layouts/LayoutDash.astro';
import PerfilProducto from '../../../components/organismos/PerfilProducto';
import { Card, CardContent, CardHeader, CardTitle } from '../../../components/organismos/Card';

// 1. Proteger la ruta y obtener datos del usuario desde la sesi√≥n
const { user } = Astro.locals;
if (!user) {
  return Astro.redirect('/login');
}
const { empresaId } = user;

// 2. Obtener el ID del producto de la URL
const { id: productoId } = Astro.params;

if (!productoId) {
  return new Response("ID de producto no encontrado", { status: 404 });
}

// 3. Obtener todos los datos en PARALELO para mejor rendimiento
const [productosResult, depositosDB, ubicacionesDB] = await Promise.all([
  // üîç PRODUCTO PRINCIPAL CON √çNDICE OPTIMIZADO
  db.select()
    .from(productosSchema)
    .where(
      and(
        eq(productosSchema.id, productoId), 
        eq(productosSchema.empresaId, empresaId)
      )
    )
    .limit(1),
  
  // üè≠ DEP√ìSITOS
  db.select()
    .from(depositosSchema)
    .where(eq(depositosSchema.empresaId, empresaId)),
  
  // üìç UBICACIONES  
  db.select()
    .from(ubicacionesSchema)
    .where(eq(ubicacionesSchema.empresaId, empresaId))
]);

const productData = productosResult[0];

if (!productData) {
  return new Response("Producto no encontrado o no pertenece a esta empresa", { status: 404 });
}

// 4. Estructura de datos optimizada para el componente
const perfilProductoData = {
  productData,
  depositosDB,
  ubicacionesDB
};
---

<LayoutDash title={`Perfil de ${productData.nombre || 'Producto'}`}>
  <!-- <div class="container mx-auto px-4 py-8">
    <div class="max-w-5xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
      <PerfilProducto 
        client:load 
        data={perfilProductoData} 
        loading={false} 
        onClose={() => window.history.back()} 
      />
    </div>
  </div> -->
  <div class="flex w-full item-center gap-4 p-10 justify-between">
<Card>
  <CardHeader>
    <CardTitle>Perfil de {productData.nombre || 'Producto'}</CardTitle>
  </CardHeader>
  <CardContent>
  </CardContent>
</Card>
<Card>
</Card>
  </div>

</LayoutDash>