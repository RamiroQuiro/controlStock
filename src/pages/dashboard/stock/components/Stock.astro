---
import MainDashboard from '../../../../components/atomos/MainDashboard.astro';
import DivBox1 from '../../../../components/atomos/DivBox1.astro';
import H2 from '../../../../components/atomos/H2.astro';
import ListradoProductos from './ListradoProductos.astro';
import Modal from '../../../../components/moleculas/Modal.astro';
import FormularioCargaProducto from '../../productos/components/FormularioCargaProducto.astro';
import FormularioCompra from './FormularioCompra';
import FormularioModificacionPrecios from './FormularioModificacionPrecios';
import ContenedorStock from './ContenedorStock.astro';
import ContenedorTablaTopEgreso from './ContenedorTablaTopEgreso';
import ContenedorTablaMovimientos from './ContenedorTablaMovimientos';
import { depositos as depositosTable, ubicaciones as ubicacionesTable } from '../../../../db/schema';
import db from '../../../../db';
import { eq } from 'drizzle-orm';
const { user } = Astro.locals;
if (!user) {
  return Astro.redirect('/login');
}
let depositos = [];
let ubicaciones = [];
try {
  depositos = await db.select({ id: depositosTable.id, nombre: depositosTable.nombre }).from(depositosTable).where(eq(depositosTable.empresaId, user.empresaId));
  ubicaciones = await db.select({ id: ubicacionesTable.id, nombre: ubicacionesTable.nombre, depositoId: ubicacionesTable.depositoId }).from(ubicacionesTable).where(eq(ubicacionesTable.empresaId, user.empresaId));
} catch (error) {
  console.log(error);
}
---

<MainDashboard h1="Stock" user={user}>
  <!-- menu -->
  <div
    slot={'menu'}
    class="flex items-center justify-end pb-2 md:gap-2 gap-1 pr-6 w-full"
  >
    <Modal label="Crear Producto" id="agregarProducto" title="Crear Nuevo Producto">
      <FormularioCargaProducto depositos={depositos} ubicaciones={ubicaciones}  />
    </Modal>
    
    <Modal label="Comprar" id="compraProveedir" title="Registrar Compra">
      <FormularioCompra user={user} client:visible />
    </Modal>


    <Modal label="Modificar Precios" id="modificarPrecios" title="Modificar Precios">
      <FormularioModificacionPrecios userId={user.id} client:visible />
    </Modal>
  </div>
  <ContenedorStock />

  <div
    class="flex md:flex-row flex-col w-full mt gap-2 items-start justify-start"
  >
    <ListradoProductos />
    <DivBox1 styleDiv="md:w-1/3 w-full">
      <div class="w-full">
        <div class="flex items-center justify-between gap-2">
          <H2>MÃ¡s Vendidos</H2>
        </div>
        <ContenedorTablaTopEgreso user={user} client:load label="topMasVendidos" />
      </div>
      <div class="w-full">
        <div class="flex items-center justify-between gap-2">
          <H2>Menos Vendidos</H2>
        </div>
        <ContenedorTablaTopEgreso label="topMenosVendidos" client:load />
      </div>

      <div class="w-full">
        <div class="flex items-center justify-between gap-2">
          <H2>Menos Movimientos Egresos</H2>
        </div>
        <ContenedorTablaMovimientos client:load />
      </div>
    </DivBox1>
  </div>
</MainDashboard>