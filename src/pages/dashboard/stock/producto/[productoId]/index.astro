---
import db from "../../../../../db";
import {
  productos,
  depositos,
  ubicaciones,
  stockActual,
  productoCategorias,
  categorias,
} from "../../../../../db/schema";
import { eq, and } from "drizzle-orm";
import LayoutDash from "../../../../../components/layouts/LayoutDash.astro";
import FormProducto from "./componentes/FormProducto";
import HistorialMovimientosDetalleProducto from "../../components/HistorialMovimientosDetalleProducto";
import TablaStockDepositos from "../../components/TablaStockDepositos";

// 1. Proteger la ruta y obtener datos del usuario desde la sesión
const { user } = Astro.locals;
if (!user) {
  return Astro.redirect("/login");
}
const { empresaId } = user;

// 2. Obtener el ID del producto de la URL
const { productoId } = Astro.params;

if (!productoId) {
  return new Response("ID de producto no encontrado", { status: 404 });
}

const [
  productoResult,
  depositosDB,
  ubicacionesDB,
  stockResult,
  categoriasResult,
] = await Promise.all([
  db
    .select()
    .from(productos)
    .where(
      and(eq(productos.id, productoId), eq(productos.empresaId, empresaId))
    )
    .limit(1),
  db.select().from(depositos).where(eq(depositos.empresaId, empresaId)),
  db.select().from(ubicaciones).where(eq(ubicaciones.empresaId, empresaId)),
  // Obtener stock detallado por depósito
  db
    .select({
      id: stockActual.id,
      cantidad: stockActual.cantidad,
      depositosId: stockActual.depositosId,
      depositoNombre: depositos.nombre,
      alertaStock: stockActual.alertaStock,
      reservado: stockActual.reservado,
    })
    .from(stockActual)
    .leftJoin(depositos, eq(stockActual.depositosId, depositos.id))
    .where(eq(stockActual.productoId, productoId)),
  // Obtener categorías del producto
  db
    .select({
      id: categorias.id,
      nombre: categorias.nombre,
      descripcion: categorias.descripcion,
    })
    .from(productoCategorias)
    .innerJoin(categorias, eq(productoCategorias.categoriaId, categorias.id))
    .where(eq(productoCategorias.productoId, productoId)),
]);

const productData = productoResult[0];
console.log("productData result", productData);

if (!productData) {
  return new Response("Producto no encontrado o no pertenece a esta empresa", {
    status: 404,
  });
}

// 4. Estructura de datos optimizada para el componente
const perfilProductoData = {
  productData,
  depositosDB,
  ubicacionesDB,
  stockActualDB: stockResult || [],
  stockDetalle: stockResult || [],
  categorias: categoriasResult || [], // Categorías del producto
};
---

<LayoutDash title={`Perfil de ${productData?.nombre || "Producto"}`}>
  <div class="flex w-full item-center flex-col gap-4 p-8 justify-between">
    <FormProducto client:load data={perfilProductoData} />
    <div class="w-full">
      <TablaStockDepositos
        client:load
        stockDetalle={perfilProductoData?.stockDetalle}
      />
    </div>
    <HistorialMovimientosDetalleProducto
      client:load
      productoId={productData?.id}
    />
  </div>
</LayoutDash>
